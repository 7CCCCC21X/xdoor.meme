<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>XDoor 空投批量查询</title>
<style>
  :root{
    --bg:#f7f8fb; --paper:#fff; --ink:#1f2937; --muted:#6b7280;
    --line:#e5e7eb; --brand:#2563eb; --ok:#16a34a; --err:#dc2626; --warn:#b45309;
    --radius:12px; --shadow:0 8px 28px rgba(0,0,0,.06);
    --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:var(--font);line-height:1.55}
  .wrap{max-width:980px;margin:32px auto;padding:0 16px}
  h1{margin:0 0 16px;font-size:20px;font-weight:800}
  .card{background:var(--paper);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
  textarea{
    width:100%;min-height:160px;border:1px solid var(--line);border-radius:10px;resize:vertical;
    padding:10px;background:#fff;font-family:var(--mono);font-size:13px
  }
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid var(--line);background:var(--brand);color:#fff;
    padding:10px 16px;border-radius:10px;font-weight:700;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
  .btn.secondary{background:#6b7280}
  .btn.ghost{background:#fff;color:#1f2937}
  .btn.link{background:#eef2ff;color:#1d4ed8;border-color:#dbe3ff}
  .btn[disabled]{opacity:.6;cursor:not-allowed}

  /* ✅ 橙色领取按钮 */
  .btn.claim{
    background:#fff7ed;        /* 浅橙底 */
    color:#c2410c;             /* 橙色字 */
    border-color:#fed7aa;      /* 橙色边框 */
  }
  .btn.claim:hover{ filter: brightness(.98); }

  /* ✅ 左侧小方块“领”标志 */
  .badge-claim{
    width:20px;height:20px;border-radius:6px;
    display:inline-grid;place-items:center;
    background:#ffedd5;
    border:1px solid #fdba74;
    color:#c2410c;
    font-size:12px;
    font-weight:900;
    line-height:1;
    letter-spacing:.5px;
  }

  .hint{color:var(--muted);font-size:12px}
  .summary{margin-top:10px}
  .summary b{font-weight:800}
  table{width:100%;border-collapse:collapse}
  thead th{background:#fafafa;border-bottom:1px solid var(--line);text-align:left;padding:10px;font-size:13px;color:#374151}
  thead th.sortable{cursor:pointer;user-select:none}
  tbody td{border-bottom:1px solid var(--line);padding:10px;font-size:14px;vertical-align:top}
  tbody tr:nth-child(odd){background:#fcfcfd}
  .addr{font-family:var(--mono);word-break:break-all}
  .num{text-align:right;font-variant-numeric:tabular-nums}
  .status{display:flex;align-items:center;gap:6px}
  .dot{width:18px;height:18px;border-radius:4px;display:inline-grid;place-items:center}
  .ok{background:#e8f7ee;border:1px solid #bfe8cb;color:var(--ok)}
  .err{background:#fdeaea;border:1px solid #f3c3c3;color:var(--err)}
  .pending{background:#eef2ff;border:1px solid #dbe3ff;color:#4f46e5}
  .warn{background:#fff7ed;border:1px solid #fde68a;color:var(--warn)}
  .text-err{color:var(--err);font-weight:700}
  .num-err{color:var(--err)}
  .blur{filter: blur(6px)}
  .small{font-size:12px}
  .select{border:1px solid var(--line);border-radius:8px;background:#fff;padding:6px 10px}
</style>
</head>

<body>
<div class="wrap">
  <h1>XDoor 空投批量查询（boost）</h1>

  <div class="card">
    <div class="row" style="width:100%">
      <div style="flex:1">
        <label for="addrs" class="hint">钱包地址（每行一个）</label>
        <textarea id="addrs" placeholder="0x....&#10;0x...."></textarea>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="start" class="btn">开始查询</button>
      <button id="stop" class="btn secondary" disabled>停止</button>

      <!-- ✅ 橙色领取传送门 + 左侧小方块“领” -->
      <a
        href="https://xdoor.meme/#/home?invitor=0x16adb923BA68E0f0856F70cA948BBD891F2503bF"
        target="_blank"
        rel="noopener"
        class="btn claim"
        title="打开 XDoor 空投领取页面"
      >
        <span class="badge-claim">领</span>
        空投领取传送门
      </a>

      <a href="https://x.com/0xXIAOc" target="_blank" rel="noopener" class="btn link">作者推特 @0xXIAOc</a>
      <span class="hint"></span>
    </div>

    <div class="row" style="margin-top:10px">
      <label class="hint"><input id="onlyOk" type="checkbox"> 只看有空投的</label>
      <label class="hint"><input id="hideAddr" type="checkbox"> 隐藏地址</label>

      <span class="hint">导出选项：</span>
      <label class="hint"><input id="exportOnlyOk" type="checkbox" checked> 仅导出有空投</label>
      <button id="btnCsv" class="btn ghost" disabled>导出 CSV</button>

      <span class="hint">复制有空投地址：</span>
      <select id="sepSel" class="select small">
        <option value="nl">换行分隔</option>
        <option value="comma">逗号分隔</option>
      </select>
      <button id="btnCopy" class="btn ghost" disabled>复制</button>
    </div>

    <div id="summary" class="summary">
      输入地址数量 <b>0</b> 个 · 成功 <b>0</b> 个 · 有空投 <b>0</b> 个 · 总空投 <b>0</b> boost
    </div>
  </div>

  <div class="card" id="tableCard" style="margin-top:16px;display:none">
    <table>
      <thead>
        <tr>
          <th style="width:60px">#</th>
          <th>地址</th>
          <th id="thAmount" class="num sortable" style="width:220px">空投数量</th>
          <th style="width:140px">状态</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <div class="hint" style="margin-top:8px">
       <span class="addr"></span>
    </div>
  </div>
</div>

<script>
  // ===== 固定参数 =====
  const BATCH_SIZE = 10;      // 一次并发 10 个
  const DECIMALS = 18;
  const API = '/api/airdrop?address=';
  const TOKEN_SYMBOL = 'boost';
  const ETH_RE = /^0x[a-fA-F0-9]{40}$/;

  // ===== DOM =====
  const $ = s => document.querySelector(s);
  const addrsEl = $('#addrs'), startBtn = $('#start'), stopBtn = $('#stop');
  const tbody = $('#tbody'), tableCard = $('#tableCard'), summary = $('#summary');
  const thAmount = $('#thAmount');
  const onlyOkEl = $('#onlyOk'), hideAddrEl = $('#hideAddr');
  const btnCsv = $('#btnCsv'), exportOnlyOkEl = $('#exportOnlyOk');
  const btnCopy = $('#btnCopy'), sepSel = $('#sepSel');

  // ===== 状态 =====
  let aborter = null;
  let rows = [];
  let results = []; // { address, status:'queued'|'running'|'OK'|'FAIL', raw, amountFmt, amountNum }
  let sortAmountAsc = null;

  function parseAddresses(text){
    return text.replace(/\r/g,'\n')
      .split(/[\n\s,;，；]+/)
      .map(s=>s.trim())
      .filter(Boolean);
  }
  function valid(a){ return ETH_RE.test(a); }
  function setBusy(b){ startBtn.disabled=b; stopBtn.disabled=!b; }

  function escapeHtml(s){
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#39;");
  }

  function toBigIntSafe(s){
    try{
      if(!/^\d+$/.test(String(s))) return 0n;
      return BigInt(String(s));
    }catch{ return 0n; }
  }

  function formatUnits(rawStr, decimals){
    const raw = toBigIntSafe(rawStr);
    const base = 10n ** BigInt(decimals);
    const ip = raw / base;
    const fp = raw % base;
    if (decimals === 0) return ip.toString();
    let fpStr = fp.toString().padStart(decimals, '0').replace(/0+$/,'');
    return fpStr ? `${ip.toString()}.${fpStr}` : ip.toString();
  }

  function addRow(idx, address){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td class="addr">${address}</td>
      <td class="num">—</td>
      <td class="status"><span class="dot warn">•</span><span> 排队中</span></td>`;
    tbody.appendChild(tr);

    const idxCell = tr.children[0];
    const addrEl = tr.children[1];
    const amtEl  = tr.children[2];
    const statEl = tr.children[3];

    return {
      idx, address, tr, idxCell, addrEl, amtEl, statEl,
      setQueued(){ statEl.innerHTML = `<span class="dot warn">•</span><span> 排队中</span>`; },
      setPending(){ statEl.innerHTML = `<span class="dot pending">…</span><span class="muted"> 查询中</span>`; },
      setOK(amountFmt){
        amtEl.textContent = amountFmt;
        amtEl.classList.remove('num-err');
        statEl.innerHTML = `<span class="dot ok">✔</span><span> 成功</span>`;
      },
      setFail(msg='失败'){
        amtEl.textContent = '0';
        amtEl.classList.add('num-err');
        statEl.innerHTML = `<span class="dot err">✖</span><span class="text-err" title="${escapeHtml(msg)}"> 失败</span>`;
      },
      setStop(){
        statEl.innerHTML = `<span class="dot err">✖</span><span class="text-err"> 已停止</span>`;
      }
    };
  }

  function updateAmountHeader(){
    let label = '空投数量';
    if (sortAmountAsc === true) label += ' ▲';
    else if (sortAmountAsc === false) label += ' ▼';
    thAmount.textContent = label;
    thAmount.classList.add('sortable');
  }

  function setSummary(total, success, eligible, sumFmt){
    summary.innerHTML = `输入地址数量 <b>${total}</b> 个 · 成功 <b>${success}</b> 个 · 有空投 <b>${eligible}</b> 个 · 总空投 <b>${sumFmt}</b> ${TOKEN_SYMBOL}`;
  }

  function applyView(){
    const onlyOk = onlyOkEl.checked;
    let idxs = results.map((_,i)=> i);

    if (onlyOk) idxs = idxs.filter(i => results[i]?.status === 'OK' && (results[i]?.amountNum||0) > 0);

    if (sortAmountAsc !== null){
      idxs.sort((a,b)=> (results[a]?.amountNum||0) - (results[b]?.amountNum||0));
      if (sortAmountAsc === false) idxs.reverse();
    }

    rows.forEach(r => r.tr.style.display = 'none');
    idxs.forEach((i, orderIdx)=>{
      const r = rows[i];
      r.tr.style.display = '';
      r.idxCell.textContent = orderIdx + 1;
      tbody.appendChild(r.tr);
    });

    rows.forEach(r => r.addrEl.classList.toggle('blur', hideAddrEl.checked));
    updateExportButtons();
    updateAmountHeader();
  }

  function updateExportButtons(){
    const anyFinished = results.some(r => r && r.status !== 'queued' && r.status !== 'running');
    const anyEligible = results.some(r => r?.status === 'OK' && (r.amountNum||0) > 0);
    btnCsv.disabled = !anyFinished;
    btnCopy.disabled = !anyEligible;
  }

  function collectForExport(onlyEligible){
    const out = results.map((r,i)=> r ? ({
      index: i+1,
      address: r.address,
      amount: r.amountFmt || '0',
      status: r.status
    }) : null).filter(Boolean);

    if (!onlyEligible) return out;
    return out.filter(r => Number(r.amount) > 0 && r.status === 'OK');
  }

  function toCsv(rows){
    const headers = ['index','address','amount','status'];
    const esc = v => v == null ? '' : /[",\n]/.test(String(v)) ? `"${String(v).replace(/"/g,'""')}"` : v;
    return [headers.join(','), ...rows.map(r => headers.map(h => esc(r[h])).join(','))].join('\n');
  }

  async function fetchOne(address, signal){
    const url = API + encodeURIComponent(address);
    const res = await fetch(url, { method:'GET', headers:{'accept':'application/json'}, cache:'no-store', signal });
    const txt = await res.text();
    if (!res.ok) throw new Error(`HTTP_${res.status}`);

    let json;
    try{ json = JSON.parse(txt); } catch { throw new Error('BAD_JSON'); }
    if (!json?.success) throw new Error(json?.message || 'SUCCESS_FALSE');

    const raw = json?.data?.amounts?.boost;
    const rawStr = raw == null ? '0' : String(raw);

    const amountFmt = formatUnits(rawStr, DECIMALS);
    const amountNum = Number(amountFmt);
    return { rawStr, amountFmt, amountNum: Number.isFinite(amountNum) ? amountNum : 0 };
  }

  function resetUI(){
    tbody.innerHTML = '';
    tableCard.style.display = 'none';
    rows = [];
    results = [];
    sortAmountAsc = null;
    updateAmountHeader();
    btnCsv.disabled = true;
    btnCopy.disabled = true;
    setSummary(0,0,0,'0');
  }

  function recomputeSummary(){
    const total = results.length;
    const success = results.filter(r => r?.status === 'OK').length;
    const eligible = results.filter(r => r?.status === 'OK' && (r.amountNum||0) > 0).length;

    let sumRaw = 0n;
    for (const r of results){
      if (r?.status === 'OK') sumRaw += toBigIntSafe(r.raw || '0');
    }
    const sumFmt = formatUnits(sumRaw.toString(), DECIMALS);
    setSummary(total, success, eligible, sumFmt);
  }

  async function runAll(list){
    for (let start = 0; start < list.length; start += BATCH_SIZE){
      if (aborter.signal.aborted) break;

      const batchIdx = [];
      const batch = [];
      for (let i = start; i < Math.min(list.length, start + BATCH_SIZE); i++){
        batchIdx.push(i);
        batch.push(list[i]);
        rows[i].setPending();
        results[i].status = 'running';
      }

      const ps = batch.map((addr, k) =>
        fetchOne(addr, aborter.signal)
          .then(r => ({ ok:true, i: batchIdx[k], r }))
          .catch(e => ({ ok:false, i: batchIdx[k], err: e }))
      );

      const settled = await Promise.all(ps);

      for (const s of settled){
        const i = s.i;
        const row = rows[i];
        if (s.ok){
          results[i] = {
            address: row.address,
            status: 'OK',
            raw: s.r.rawStr,
            amountFmt: s.r.amountFmt,
            amountNum: s.r.amountNum
          };
          row.setOK(s.r.amountFmt);
        } else {
          results[i] = { address: row.address, status:'FAIL', raw:'0', amountFmt:'0', amountNum:0 };
          row.setFail(s.err?.message || 'FAIL');
        }
      }

      applyView();
      recomputeSummary();
    }
  }

  startBtn.addEventListener('click', async ()=>{
    resetUI();

    const list = Array.from(new Set(parseAddresses(addrsEl.value).filter(valid).map(a => a)));
    if (list.length === 0){
      alert('请粘贴至少一个有效 EVM 地址（0x 开头，40 位 hex）');
      return;
    }

    tableCard.style.display = 'block';
    list.forEach((addr, i)=>{
      rows.push(addRow(i, addr));
      results.push({ address: addr, status:'queued', raw:'0', amountFmt:'0', amountNum:0 });
    });

    aborter = new AbortController();
    setBusy(true);

    try{
      await runAll(list);
    } finally {
      setBusy(false);
      applyView();
      recomputeSummary();
    }
  });

  stopBtn.addEventListener('click', ()=>{
    if (aborter) aborter.abort();
    rows.forEach(r => r.setStop());
    setBusy(false);
  });

  onlyOkEl.addEventListener('change', applyView);
  hideAddrEl.addEventListener('change', applyView);

  thAmount.addEventListener('click', ()=>{
    sortAmountAsc = (sortAmountAsc === null) ? false : !sortAmountAsc;
    applyView();
  });

  btnCsv.addEventListener('click', ()=>{
    const data = collectForExport(exportOnlyOkEl.checked);
    if (data.length === 0) return;
    const csv = toCsv(data);
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    const a = Object.assign(document.createElement('a'), {
      href: URL.createObjectURL(blob),
      download: 'xdoor_results.csv'
    });
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
  });

  btnCopy.addEventListener('click', async ()=>{
    const okAddrs = results
      .filter(r => r?.status === 'OK' && (r.amountNum||0) > 0)
      .map(r => r.address);

    if (okAddrs.length === 0){ alert('没有有空投的地址'); return; }

    const sep = (sepSel.value === 'comma') ? ',' : '\n';
    const text = okAddrs.join(sep);

    try{
      await navigator.clipboard.writeText(text);
      alert(`已复制 ${okAddrs.length} 个有空投地址`);
    }catch{
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      alert(`已复制 ${okAddrs.length} 个有空投地址`);
    }
  });

  updateAmountHeader();
</script>
</body>
</html>
